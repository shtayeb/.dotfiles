# Neovim build from source
# Build is user space, only 'make install' needs sudo

- name: Remove existing neovim build directory
  file:
    path: "{{ home_dir }}/neovim"
    state: absent
  tags: [install, neovim]

- name: Clone Neovim repository
  git:
    repo: "https://github.com/neovim/neovim.git"
    dest: "{{ home_dir }}/neovim"
    depth: 1
    version: stable
  tags: [install, neovim]

- name: Build neovim
  shell: make CMAKE_BUILD_TYPE=Release -j{{ ansible_processor_vcpus | default(4) }}
  args:
    chdir: "{{ home_dir }}/neovim"
  tags: [install, neovim]

- name: Install neovim
  become: true
  shell: make install
  args:
    chdir: "{{ home_dir }}/neovim"
  tags: [install, neovim]

# JetBrains Mono Nerd Font (user space)
- name: Ensure fonts directory exists
  file:
    path: "{{ home_dir }}/.fonts"
    state: directory
    mode: '0755'
  tags: [install, neovim]

- name: Check if JetBrains Mono exists
  find:
    paths: "{{ home_dir }}/.fonts"
    patterns: "JetBrainsMono*"
  register: jetbrains_font
  tags: [install, neovim]

- name: Download JetBrains Mono Nerd Font
  when: jetbrains_font.matched == 0
  unarchive:
    src: https://github.com/ryanoasis/nerd-fonts/releases/download/v3.1.1/JetBrainsMono.zip
    dest: "{{ home_dir }}/.fonts/"
    remote_src: yes
  tags: [install, neovim]

- name: Refresh font cache
  when: jetbrains_font.matched == 0
  shell: fc-cache -fv
  changed_when: false
  tags: [install, neovim]
